import{E as L,H as v}from"./github-d8d05c61.js";import{W as z}from"./WaitingForRestart-f77d905b.js";import{A as T}from"./AstrBotConfig-b6194601.js";import{C as A}from"./ConsoleDisplayer-6264eb94.js";import{m as d,b as s,w as o,X as _,W as S,ae as I,F as D,l as b,o as i,c as f,ar as B,Y as c,g as k,E as V,G as x,q as n,v as m,f as y,e as u,x as G,t as p,D as C,S as R,H as M,p as E,R as U,y as j,I as N,as as W,U as P,T as $,V as F}from"./index-809c946b.js";import{u as q}from"./common-a3b3ada7.js";import{m as H}from"./marked.esm-7c36e8b8.js";import"./_plugin-vue_export-helper-c27b6911.js";const K={class:"pl-2 pt-2 d-flex align-center pe-2"},O=n("h2",null,"✨ 插件市场",-1),J=n("span",null," 如无法显示，请单击此按钮跳转至插件市场，复制想安装插件对应的 `repo` 链接然后点击右下角 + 号安装，或打开链接下载压缩包安装。 如果因为网络问题安装失败，点击设置页选择 GitHub 加速地址。或前往仓库下载压缩包然后本地上传。 ",-1),X=n("small",{style:{color:"#bbb"}},"每个插件都是作者无偿提供的的劳动成果。如果您喜欢某个插件，请 Star！",-1),Y={key:0,class:"mt-4"},Z=n("h2",null,"🥳 推荐",-1),Q={key:1,class:"mt-4"},ee=n("h2",null,"📦 全部插件",-1),te={class:"d-flex align-center",style:{"overflow-x":"scroll"}},ae=["src"],le={key:1},se=["href"],oe={key:2},ne={style:{"font-size":"13px"}},ie={style:{"font-size":"12px"}},re={key:0},de=["href"],ue={key:1},he=["href"],ge=["src","alt"],me={key:0},pe={key:2,class:"mt-4"},ce=n("h2",null,"📦 全部插件",-1),fe=n("small",null,[n("a",{href:"https://astrbot.app/dev/plugin.html"},"插件开发文档")],-1),_e=n("small",null,[n("a",{href:"https://github.com/Soulter/AstrBot_Plugins_Collection"},"提交插件仓库")],-1),ke=n("span",{class:"text-h5"},"安装插件",-1),ye=n("h3",null,"从 GitHub 上在线下载",-1),we=n("small",null,"请输入合法的 GitHub 仓库链接，当前仅支持 GitHub。如：https://github.com/Soulter/astrbot_plugin_aiocqhttp",-1),De=n("h3",null,"从本机上传 .zip 压缩包",-1),be=n("small",null,"请保证插件文件存在压缩包根目录中的第一个文件夹中（即类似于从 GitHub 仓库页上下载的 Zip 压缩包的格式）。",-1),ve=n("br",null,null,-1),Ve=n("span",{class:"text-h5"},"插件说明文档",-1),xe=["innerHTML"],Ce={key:1,class:"d-flex flex-column align-center justify-center",style:{height:"100%"}},Me={class:"text-body-1 text-center mb-4"},Ee={key:2,class:"d-flex flex-column align-center justify-center",style:{height:"100%"}},Le=n("p",{class:"text-body-1 text-center mb-4"},[u("该插件未提供文档链接或GitHub仓库地址。"),n("br"),u("请查看插件市场或联系插件作者获取更多信息。")],-1),Se={name:"ExtensionPage",components:{ExtensionCard:L,WaitingForRestart:z,ConsoleDisplayer:A,AstrBotConfig:T},data(){return{extension_data:{data:[],message:""},extension_url:"",status:"",dialog:!1,snack_message:"",snack_show:!1,snack_success:"success",loading_:!1,upload_file:null,pluginMarketData:[],loadingDialog:{show:!1,title:"加载中...",statusCode:0,result:""},readmeDialog:{show:!1,url:null,content:null,error:null},announcement:"",isListView:!0,pluginMarketHeaders:[{title:"名称",key:"name",maxWidth:"200px"},{title:"描述",key:"desc",maxWidth:"250px"},{title:"作者",key:"author",maxWidth:"70px"},{title:"Star数",key:"stars",maxWidth:"100px"},{title:"标签",key:"tags",maxWidth:"100px"},{title:"操作",key:"actions",sortable:!1}],marketSearch:"",commonStore:q(),filterKeys:["name","desc","author"]}},computed:{filteredPluginMarketData(){if(!this.marketSearch)return this.pluginMarketData;const l=this.marketSearch.toLowerCase();return this.pluginMarketData.filter(e=>this.filterKeys.some(a=>{var t;return(t=e[a])==null?void 0:t.toLowerCase().includes(l)}))},pinnedPlugins(){return this.pluginMarketData.filter(l=>l==null?void 0:l.pinned)}},mounted(){this.getExtensions(),this.loading_=!0,this.commonStore.getPluginCollections().then(l=>{this.pluginMarketData=l,this.checkAlreadyInstalled(),this.checkUpdate(),this.loading_=!1}).catch(l=>{console.error("获取插件市场数据失败:",l)}),b.get("https://api.soulter.top/astrbot-announcement-plugin-market").then(l=>{let e=l.data.data;this.announcement=e.text})},methods:{open(l){l&&window.open(l,"_blank")},jumpToPluginMarket(){window.open("https://soulter.github.io/AstrBot_Plugins_Collection/plugins.json","_blank")},toast(l,e){this.snack_message=l,this.snack_show=!0,this.snack_success=e},resetLoadingDialog(){this.loadingDialog={show:!1,title:"加载中...",statusCode:0,result:""}},onLoadingDialogResult(l,e,a=2e3){this.loadingDialog.statusCode=l,this.loadingDialog.result=e,a!==-1&&setTimeout(()=>{this.resetLoadingDialog()},a)},getExtensions(){b.get("/api/plugin/get").then(l=>{this.extension_data=l.data,this.checkAlreadyInstalled(),this.checkUpdate()})},checkUpdate(){const l=new Map,e=new Map;this.pluginMarketData.forEach(a=>{a.repo&&l.set(a.repo.toLowerCase(),a),e.set(a.name,a)}),this.extension_data.data.forEach(a=>{var w;const t=(w=a.repo)==null?void 0:w.toLowerCase(),g=t?l.get(t):null,r=e.get(a.name),h=g||r;h?(a.online_version=h.version,a.has_update=a.version!==h.version&&h.version!=="未知"):a.has_update=!1})},async getReadmeUrl(l){l=l.replace(/\/+$/,"");const e=l.match(/github\.com\/([^/]+)\/([^/]+)/);if(!e)throw new Error("无效的 GitHub 仓库地址");const a=e[1],t=e[2],g=`https://api.github.com/repos/${a}/${t}`;try{const h=await(await fetch(g)).json(),w=(h==null?void 0:h.default_branch)||"master";return`${l}/blob/${w}/README.md`}catch(r){return console.error("获取默认分支失败，使用 master 作为默认：",r),`${l}/blob/master/README.md`}},async showReadmeDialog(l){var e,a;this.readmeDialog.content=null,this.readmeDialog.error=null,(a=(e=l==null?void 0:l.data)==null?void 0:e.data)!=null&&a.repo?(this.readmeDialog.url=await this.getReadmeUrl(l.data.data.repo),l.data.data.readme?this.readmeDialog.content=l.data.data.readme:this.readmeDialog.error="插件未提供README文档"):(this.readmeDialog.url=null,this.readmeDialog.error="插件没有仓库信息或README文档"),this.readmeDialog.show=!0},async newExtension(){if(this.extension_url===""&&this.upload_file===null){this.toast("请填写插件链接或上传插件文件","error");return}if(this.extension_url!==""&&this.upload_file!==null){this.toast("请不要同时填写插件链接和上传插件文件","error");return}if(this.loading_=!0,this.loadingDialog.show=!0,this.upload_file!==null){this.toast("正在从文件安装插件","primary");const l=new FormData;l.append("file",this.upload_file),b.post("/api/plugin/install-upload",l,{headers:{"Content-Type":"multipart/form-data"}}).then(async e=>{if(this.loading_=!1,e.data.status==="error"){this.onLoadingDialogResult(2,e.data.message,-1);return}this.extension_data=e.data,this.upload_file="",this.onLoadingDialogResult(1,e.data.message),this.dialog=!1,this.getExtensions(),await this.showReadmeDialog(e)}).catch(e=>{this.loading_=!1,this.onLoadingDialogResult(2,e,-1)});return}else this.toast("正在从链接 "+this.extension_url+" 安装插件...","primary"),b.post("/api/plugin/install",{url:this.extension_url,proxy:localStorage.getItem("selectedGitHubProxy")||""}).then(async l=>{if(this.loading_=!1,this.toast(l.data.message,l.data.status==="ok"?"success":"error"),l.data.status==="error"){this.onLoadingDialogResult(2,l.data.message,-1);return}this.extension_data=l.data,this.extension_url="",this.onLoadingDialogResult(1,l.data.message),this.dialog=!1,this.getExtensions(),await this.showReadmeDialog(l)}).catch(l=>{this.loading_=!1,this.toast("安装插件失败: "+l,"error"),this.onLoadingDialogResult(2,l,-1)})},checkAlreadyInstalled(){var g;const l=new Set(this.extension_data.data.map(r=>{var h;return(h=r.repo)==null?void 0:h.toLowerCase()})),e=new Set(this.extension_data.data.map(r=>r.name));for(let r=0;r<this.pluginMarketData.length;r++){const h=this.pluginMarketData[r];h.installed=l.has((g=h.repo)==null?void 0:g.toLowerCase())||e.has(h.name)}let a=[],t=[];for(let r=0;r<this.pluginMarketData.length;r++)this.pluginMarketData[r].installed?a.push(this.pluginMarketData[r]):t.push(this.pluginMarketData[r]);this.pluginMarketData=t.concat(a)},openReadmeInNewTab(){this.readmeDialog.url&&window.open(this.readmeDialog.url,"_blank")},renderMarkdown(l){return l?(H.setOptions({highlight:function(e,a){if(a&&v.getLanguage(a))try{return v.highlight(e,{language:a}).value}catch(t){console.error(t)}return v.highlightAuto(e).value},gfm:!0,breaks:!0,headerIds:!0,mangle:!1}),H(l)):""}}},Be=Object.assign(Se,{setup(l){return(e,a)=>(i(),d(D,null,[s(_,null,{default:o(()=>[e.announcement?(i(),f(c,{key:0,cols:"12",md:"12"},{default:o(()=>[s(B,{color:"success",lines:"one",text:e.announcement,stacked:!1},null,8,["text"])]),_:1})):k("",!0),s(c,{cols:"12",md:"12"},{default:o(()=>[s(V,null,{default:o(()=>[s(x,null,{default:o(()=>[n("div",K,[O,s(m,{icon:"",size:"small",style:{"margin-left":"8px"},variant:"plain",onClick:a[0]||(a[0]=t=>e.jumpToPluginMarket())},{default:o(()=>[s(y,{size:"small"},{default:o(()=>[u("mdi-help")]),_:1}),s(G,{activator:"parent",location:"start"},{default:o(()=>[J]),_:1})]),_:1}),s(m,{icon:"",onClick:a[1]||(a[1]=t=>e.isListView=!e.isListView),size:"small",style:{"margin-left":"auto"},variant:"plain"},{default:o(()=>[s(y,null,{default:o(()=>[u(p(e.isListView?"mdi-view-grid":"mdi-view-list"),1)]),_:1})]),_:1}),s(C),s(R,{modelValue:e.marketSearch,"onUpdate:modelValue":a[2]||(a[2]=t=>e.marketSearch=t),density:"compact",label:"Search","prepend-inner-icon":"mdi-magnify",variant:"solo-filled",flat:"","hide-details":"","single-line":""},null,8,["modelValue"])])]),_:1}),s(M,null,{default:o(()=>[X,e.pinnedPlugins.length>0?(i(),d("div",Y,[Z,s(_,{style:{"margin-top":"8px"}},{default:o(()=>[(i(!0),d(D,null,E(e.pinnedPlugins,t=>(i(),f(c,{cols:"12",md:"6",lg:"6"},{default:o(()=>[s(L,{extension:t,"market-mode":"true",highlight:!0},null,8,["extension"])]),_:2},1024))),256))]),_:1})])):k("",!0),e.isListView?(i(),d("div",Q,[ee,s(c,{cols:"12",md:"12",style:{padding:"0px"}},{default:o(()=>[s(U,{headers:e.pluginMarketHeaders,items:e.pluginMarketData,"item-key":"name",loading:e.loading_,search:e.marketSearch,"onUpdate:search":a[3]||(a[3]=t=>e.marketSearch=t),"filter-keys":e.filterKeys},{"item.name":o(({item:t})=>[n("div",te,[t.logo?(i(),d("img",{key:0,src:t.logo,style:{height:"80px",width:"80px","margin-right":"8px","border-radius":"8px","margin-top":"8px","margin-bottom":"8px"},alt:"logo"},null,8,ae)):k("",!0),t!=null&&t.repo?(i(),d("span",le,[n("a",{href:t==null?void 0:t.repo,style:{color:"#000","text-decoration":"none"}},p(t.name),9,se)])):(i(),d("span",oe,p(t.name),1))])]),"item.desc":o(({item:t})=>[n("div",ne,p(t.desc),1)]),"item.author":o(({item:t})=>[n("div",ie,[t!=null&&t.social_link?(i(),d("span",re,[n("a",{href:t==null?void 0:t.social_link},p(t.author),9,de)])):(i(),d("span",ue,p(t.author),1))])]),"item.stars":o(({item:t})=>[n("a",{href:t.repo},[t.repo?(i(),d("img",{key:0,src:`https://img.shields.io/github/stars/${t.repo.split("/").slice(-2).join("/")}.svg`,alt:`Stars for ${t.name}`,style:{height:"20px"}},null,8,ge)):k("",!0)],8,he)]),"item.tags":o(({item:t})=>[t.tags.length===0?(i(),d("span",me,"无")):k("",!0),(i(!0),d(D,null,E(t.tags,g=>(i(),f(F,{key:g,color:"primary",size:"x-small"},{default:o(()=>[u(p(g),1)]),_:2},1024))),128))]),"item.actions":o(({item:t})=>[t.installed?(i(),f(m,{key:1,class:"text-none mr-2",size:"x-small",variant:"flat",border:"",disabled:""},{default:o(()=>[u("已安装")]),_:1})):(i(),f(m,{key:0,class:"text-none mr-2",size:"x-small",variant:"flat",border:"",onClick:g=>{e.extension_url=t.repo,e.newExtension()}},{default:o(()=>[u("安装")]),_:2},1032,["onClick"])),s(m,{class:"text-none mr-2",size:"x-small",variant:"flat",border:"",onClick:g=>e.open(t.repo)},{default:o(()=>[u("帮助")]),_:2},1032,["onClick"])]),_:1},8,["headers","items","loading","search","filter-keys"])]),_:1})])):(i(),d("div",pe,[ce,s(_,{style:{"margin-top":"16px"}},{default:o(()=>[(i(!0),d(D,null,E(e.filteredPluginMarketData,t=>(i(),f(c,{cols:"12",md:"6",lg:"6"},{default:o(()=>[s(L,{extension:t,"market-mode":"true"},null,8,["extension"])]),_:2},1024))),256))]),_:1})]))]),_:1})]),_:1})]),_:1}),s(c,{style:{"margin-bottom":"16px"},cols:"12",md:"12"},{default:o(()=>[fe,u(" | "),_e]),_:1})]),_:1}),s(S,{modelValue:e.dialog,"onUpdate:modelValue":a[8]||(a[8]=t=>e.dialog=t),width:"700"},{activator:o(({props:t})=>[s(m,j(t,{icon:"mdi-plus",size:"x-large",style:{position:"fixed",right:"52px",bottom:"52px"},color:"darkprimary"}),null,16)]),default:o(()=>[s(V,null,{default:o(()=>[s(x,null,{default:o(()=>[ke]),_:1}),s(M,null,{default:o(()=>[s(N,null,{default:o(()=>[s(_,null,{default:o(()=>[ye,s(c,{cols:"12"},{default:o(()=>[we,s(R,{label:"仓库链接",modelValue:e.extension_url,"onUpdate:modelValue":a[4]||(a[4]=t=>e.extension_url=t),variant:"outlined",required:""},null,8,["modelValue"])]),_:1})]),_:1}),s(_,null,{default:o(()=>[De,s(c,{cols:"12"},{default:o(()=>[be,s(W,{label:"选择文件",modelValue:e.upload_file,"onUpdate:modelValue":a[5]||(a[5]=t=>e.upload_file=t),accept:".zip",outlined:"",required:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),ve,n("small",null,p(e.status),1)]),_:1}),s(P,null,{default:o(()=>[s(C),s(m,{color:"blue-darken-1",variant:"text",onClick:a[6]||(a[6]=t=>e.dialog=!1)},{default:o(()=>[u(" 关闭 ")]),_:1}),s(m,{color:"blue-darken-1",variant:"text",loading:e.loading_,onClick:a[7]||(a[7]=t=>e.newExtension())},{default:o(()=>[u(" 安装 ")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(I,{timeout:2e3,elevation:"24",color:e.snack_success,modelValue:e.snack_show,"onUpdate:modelValue":a[9]||(a[9]=t=>e.snack_show=t)},{default:o(()=>[u(p(e.snack_message),1)]),_:1},8,["color","modelValue"]),s(z,{ref:"wfr"},null,512),s(S,{modelValue:e.readmeDialog.show,"onUpdate:modelValue":a[13]||(a[13]=t=>e.readmeDialog.show=t),width:"800",persistent:""},{default:o(()=>[s(V,null,{default:o(()=>[s(x,{class:"d-flex justify-space-between align-center"},{default:o(()=>[Ve,s(m,{icon:"",onClick:a[10]||(a[10]=t=>e.readmeDialog.show=!1)},{default:o(()=>[s(y,null,{default:o(()=>[u("mdi-close")]),_:1})]),_:1})]),_:1}),s($),s(M,{style:{height:"70vh","overflow-y":"auto"}},{default:o(()=>[s(m,{color:"primary","prepend-icon":"mdi-open-in-new",onClick:a[11]||(a[11]=t=>e.openReadmeInNewTab()),class:"mt-4"},{default:o(()=>[u(" 在GitHub中查看文档 ")]),_:1}),e.readmeDialog.content?(i(),d("div",{key:0,class:"markdown-body",innerHTML:e.renderMarkdown(e.readmeDialog.content)},null,8,xe)):e.readmeDialog.error?(i(),d("div",Ce,[s(y,{size:"64",color:"error",class:"mb-4"},{default:o(()=>[u("mdi-alert-circle-outline")]),_:1}),n("p",Me,p(e.readmeDialog.error),1)])):(i(),d("div",Ee,[s(y,{size:"64",color:"warning",class:"mb-4"},{default:o(()=>[u("mdi-file-question-outline")]),_:1}),Le]))]),_:1}),s($),s(P,null,{default:o(()=>[s(C),s(m,{color:"primary",variant:"tonal",onClick:a[12]||(a[12]=t=>e.readmeDialog.show=!1)},{default:o(()=>[u(" 关闭 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}});export{Be as default};
