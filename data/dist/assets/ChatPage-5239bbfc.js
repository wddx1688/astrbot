import{c as y,w as n,E as U,r as K,l as p,o as r,b as l,q as a,v as f,e as m,m as c,g,n as z,p as b,F as C,aj as B,f as v,V as R,S as M,L as $,x as S,y as E,H as F,j as O,h as P,i as j,t as L,aH as A,u as N}from"./index-809c946b.js";import{m as V}from"./marked.esm-7c36e8b8.js";const H={class:"chat-layout"},G={class:"sidebar-panel"},J={class:"sidebar-header"},W={class:"conversations-container"},q={key:0,class:"sidebar-section-title"},Q={key:0,class:"no-conversations"},X=a("div",{class:"no-conversations-text"},"暂无对话历史",-1),Y={class:"sidebar-footer"},Z=a("div",{class:"sidebar-section-title"}," 系统状态 ",-1),x={class:"status-chips"},ee={class:"chat-content-panel"},te={class:"messages-container",ref:"messageContainer"},se={key:0,class:"welcome-container fade-in"},ae=a("div",{class:"welcome-title"},[a("span",null,"Hello, I'm"),a("span",{class:"bot-name"},"AstrBot ⭐")],-1),ie=a("div",{class:"welcome-hint"},[a("span",null,"输入"),a("code",null,"help"),a("span",null,"获取帮助 😊")],-1),oe=a("div",{class:"welcome-hint"},[a("span",null,"长按"),a("code",null,"Ctrl"),a("span",null,"录制语音 🎤")],-1),le=a("div",{class:"welcome-hint"},[a("span",null,"按"),a("code",null,"Ctrl + V"),a("span",null,"粘贴图片 🏞️")],-1),ne=[ae,ie,oe,le],re={key:1,class:"message-list"},de={key:0,class:"user-message"},ce={class:"message-bubble user-bubble"},ue={key:0,class:"image-attachments"},he=["src"],me={key:1,class:"audio-attachment"},ge={controls:"",class:"audio-player"},pe=["src"],ve={key:1,class:"bot-message"},fe=a("span",{class:"text-h6"},"✨",-1),_e={class:"message-bubble bot-bubble"},ye=["innerHTML"],be={class:"input-area fade-in"},Ce={key:0,class:"attachments-preview"},ke=["src"],we={key:0,class:"audio-preview"},Te={name:"ChatPage",components:{},data(){return{prompt:"",messages:[],conversations:[],currCid:"",stagedImagesUrl:[],loadingChat:!1,inputFieldLabel:"聊天吧!",isRecording:!1,audioChunks:[],stagedAudioUrl:"",mediaRecorder:null,status:{},statusText:"",eventSource:null,ctrlKeyDown:!1,ctrlKeyTimer:null,ctrlKeyLongPressThreshold:300}},mounted(){this.startListeningEvent(),this.checkStatus(),this.getConversations();let t=document.getElementById("input-field");t.addEventListener("paste",this.handlePaste),t.addEventListener("keydown",(function(e){e.keyCode==13&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}).bind(this)),document.addEventListener("keyup",this.handleInputKeyUp)},beforeUnmount(){this.eventSource&&(this.eventSource.cancel(),console.log("SSE连接已断开")),document.removeEventListener("keyup",this.handleInputKeyUp)},methods:{async startListeningEvent(){const t=await fetch("/api/chat/listen",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok){console.error("SSE连接失败:",t.statusText);return}const e=t.body.getReader(),s=new TextDecoder;this.eventSource=e;let o=!1,d=null;for(;;){const{done:i,value:h}=await e.read();if(i){console.log("SSE连接关闭");break}let _=s.decode(h,{stream:!0}).split(`

`);console.log("SSE数据:",_);for(let w=0;w<_.length;w++){let T=_[w].trim();if(!T)continue;console.log(T);let u=JSON.parse(T.replace("data: ",""));if(u.type!=="heartbeat"){if(u.type==="error"){console.error("Error received:",u.data);continue}if(u.type==="image"){let I={type:"bot",message:`<img src="/api/chat/get_file?filename=${u.data.replace("[IMAGE]","")}" style="max-width: 80%; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);"/>`};this.messages.push(I)}else if(u.type==="record"){let I={type:"bot",message:`<audio controls class="audio-player">
                    <source src="/api/chat/get_file?filename=${u.data.replace("[RECORD]","")}" type="audio/wav">
                    您的浏览器不支持音频播放。
                  </audio>`};this.messages.push(I)}else if(u.type==="plain")o?d.message.value+=u.data:(d={type:"bot",message:K(u.data)},this.messages.push(d),o=!0);else if(u.type==="end"){o=!1;continue}this.scrollToBottom()}}}},removeAudio(){this.stagedAudioUrl=null},checkStatus(){p.get("/api/chat/status").then(t=>{console.log(t.data),this.status=t.data.data}).catch(t=>{console.error(t)})},async startRecording(){const t=await navigator.mediaDevices.getUserMedia({audio:!0});this.mediaRecorder=new MediaRecorder(t),this.mediaRecorder.ondataavailable=e=>{this.audioChunks.push(e.data)},this.mediaRecorder.start(),this.isRecording=!0,this.inputFieldLabel="录音中，请说话..."},async stopRecording(){this.isRecording=!1,this.inputFieldLabel="聊天吧!",this.mediaRecorder.stop(),this.mediaRecorder.onstop=async()=>{const t=new Blob(this.audioChunks,{type:"audio/wav"});this.audioChunks=[],this.mediaRecorder.stream.getTracks().forEach(s=>s.stop());const e=new FormData;e.append("file",t);try{const o=(await p.post("/api/chat/post_file",e,{headers:{"Content-Type":"multipart/form-data",Authorization:"Bearer "+localStorage.getItem("token")}})).data.data.filename;console.log("Audio uploaded:",o),this.stagedAudioUrl=`/api/chat/get_file?filename=${o}`}catch(s){console.error("Error uploading audio:",s)}}},async handlePaste(t){console.log("Pasting image...");const e=t.clipboardData.items;for(let s=0;s<e.length;s++)if(e[s].type.indexOf("image")!==-1){const o=e[s].getAsFile(),d=new FormData;d.append("file",o);try{const h=(await p.post("/api/chat/post_image",d,{headers:{"Content-Type":"multipart/form-data",Authorization:"Bearer "+localStorage.getItem("token")}})).data.data.filename;this.stagedImagesUrl.push(`/api/chat/get_file?filename=${h}`)}catch(i){console.error("Error uploading image:",i)}}},removeImage(t){this.stagedImagesUrl.splice(t,1)},clearMessage(){this.prompt=""},getConversations(){p.get("/api/chat/conversations").then(t=>{this.conversations=t.data.data}).catch(t=>{console.error(t)})},getConversationMessages(t){t[0]&&p.get("/api/chat/get_conversation?conversation_id="+t[0]).then(e=>{this.currCid=t[0];let s=JSON.parse(e.data.data.history);for(let o=0;o<s.length;o++){if(s[o].message.startsWith("[IMAGE]")){let d=s[o].message.replace("[IMAGE]","");s[o].message=`<img src="/api/chat/get_file?filename=${d}" style="max-width: 80%; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);"/>`}if(s[o].message.startsWith("[RECORD]")){let d=s[o].message.replace("[RECORD]","");s[o].message=`<audio controls class="audio-player">
                                    <source src="/api/chat/get_file?filename=${d}" type="audio/wav">
                                    您的浏览器不支持音频播放。
                                  </audio>`}if(s[o].image_url&&s[o].image_url.length>0)for(let d=0;d<s[o].image_url.length;d++)s[o].image_url[d]=`/api/chat/get_file?filename=${s[o].image_url[d]}`;s[o].audio_url&&(s[o].audio_url=`/api/chat/get_file?filename=${s[o].audio_url}`)}this.messages=s}).catch(e=>{console.error(e)})},async newConversation(){await p.get("/api/chat/new_conversation").then(t=>{this.currCid=t.data.data.conversation_id,this.getConversations()}).catch(t=>{console.error(t)})},newC(){this.currCid="",this.messages=[]},formatDate(t){const e=new Date(t*1e3),s={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1};return e.toLocaleString("zh-CN",s).replace(/\//g,"-").replace(/, /g," ")},deleteConversation(t){p.get("/api/chat/delete_conversation?conversation_id="+t).then(e=>{this.getConversations(),this.currCid="",this.messages=[]}).catch(e=>{console.error(e)})},async sendMessage(){this.currCid==""&&await this.newConversation(),this.messages.push({type:"user",message:this.prompt,image_url:this.stagedImagesUrl,audio_url:this.stagedAudioUrl}),this.scrollToBottom();let t=[];for(let s=0;s<this.stagedImagesUrl.length;s++){let o=this.stagedImagesUrl[s].replace("/api/chat/get_file?filename=","");t.push(o)}let e=[];if(this.stagedAudioUrl){let s=this.stagedAudioUrl.replace("/api/chat/get_file?filename=","");e.push(s)}this.loadingChat=!0,fetch("/api/chat/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({message:this.prompt,conversation_id:this.currCid,image_url:t,audio_url:e})}).then(s=>{this.prompt="",this.stagedImagesUrl=[],this.stagedAudioUrl="",this.loadingChat=!1}).catch(s=>{console.error(s)})},scrollToBottom(){this.$nextTick(()=>{const t=this.$refs.messageContainer;t.scrollTop=t.scrollHeight})},handleInputKeyDown(t){if(t.keyCode===17){if(this.ctrlKeyDown)return;this.ctrlKeyDown=!0,this.ctrlKeyTimer=setTimeout(()=>{this.ctrlKeyDown&&!this.isRecording&&this.startRecording()},this.ctrlKeyLongPressThreshold)}},handleInputKeyUp(t){t.keyCode===17&&(this.ctrlKeyDown=!1,this.ctrlKeyTimer&&(clearTimeout(this.ctrlKeyTimer),this.ctrlKeyTimer=null),this.isRecording&&this.stopRecording())}}},Ue=Object.assign(Te,{setup(t){return V.setOptions({breaks:!0}),(e,s)=>(r(),y(U,{class:"chat-page-card"},{default:n(()=>[l(F,{class:"chat-page-container"},{default:n(()=>{var o,d;return[a("div",H,[a("div",G,[a("div",J,[l(f,{variant:"elevated",rounded:"lg",class:"new-chat-btn",onClick:e.newC,disabled:!e.currCid,"prepend-icon":"mdi-plus"},{default:n(()=>[m(" 创建对话 ")]),_:1},8,["onClick","disabled"])]),a("div",W,[e.conversations.length>0?(r(),c("div",q," 对话历史 ")):g("",!0),e.conversations.length>0?(r(),y(U,{key:1,class:"conversation-list-card",flat:""},{default:n(()=>[l(z,{density:"compact",nav:"",class:"conversation-list","onUpdate:selected":e.getConversationMessages},{default:n(()=>[(r(!0),c(C,null,b(e.conversations,(i,h)=>(r(),y(O,{key:i.cid,value:i.cid,color:"primary",rounded:"lg",class:"conversation-item","active-color":"primary"},{prepend:n(()=>[l(v,{size:"small",icon:"mdi-message-text-outline"})]),default:n(()=>[l(P,{class:"conversation-title"},{default:n(()=>[m("新对话")]),_:1}),l(j,{class:"timestamp"},{default:n(()=>[m(L(e.formatDate(i.updated_at)),1)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["onUpdate:selected"])]),_:1})):g("",!0),l(B,null,{default:n(()=>[e.conversations.length===0?(r(),c("div",Q,[l(v,{icon:"mdi-message-text-outline",size:"large",color:"grey-lighten-1"}),X])):g("",!0)]),_:1})]),a("div",Y,[Z,a("div",x,[l(R,{class:"status-chip",color:(o=e.status)!=null&&o.llm_enabled?"primary":"grey-lighten-2",variant:"elevated",size:"small"},{prepend:n(()=>{var i;return[l(v,{icon:(i=e.status)!=null&&i.llm_enabled?"mdi-check-circle":"mdi-alert-circle",size:"x-small"},null,8,["icon"])]}),default:n(()=>[m(" LLM 服务 ")]),_:1},8,["color"]),l(R,{class:"status-chip",color:(d=e.status)!=null&&d.stt_enabled?"success":"grey-lighten-2",variant:"elevated",size:"small"},{prepend:n(()=>{var i;return[l(v,{icon:(i=e.status)!=null&&i.stt_enabled?"mdi-check-circle":"mdi-alert-circle",size:"x-small"},null,8,["icon"])]}),default:n(()=>[m(" 语音转文本 ")]),_:1},8,["color"])]),e.currCid?(r(),y(f,{key:0,variant:"tonal",rounded:"lg",class:"delete-chat-btn",onClick:s[0]||(s[0]=i=>e.deleteConversation(e.currCid)),color:"error",density:"comfortable",size:"small"},{default:n(()=>[l(v,{start:"",size:"small"},{default:n(()=>[m("mdi-delete")]),_:1}),m(" 删除此对话 ")]),_:1})):g("",!0)])]),a("div",ee,[a("div",te,[e.messages.length==0?(r(),c("div",se,ne)):(r(),c("div",re,[(r(!0),c(C,null,b(e.messages,(i,h)=>(r(),c("div",{class:"message-item fade-in",key:h},[i.type=="user"?(r(),c("div",de,[a("div",ce,[a("span",null,L(i.message),1),i.image_url&&i.image_url.length>0?(r(),c("div",ue,[(r(!0),c(C,null,b(i.image_url,(k,_)=>(r(),c("div",{key:_,class:"image-attachment"},[a("img",{src:k,class:"attached-image"},null,8,he)]))),128))])):g("",!0),i.audio_url&&i.audio_url.length>0?(r(),c("div",me,[a("audio",ge,[a("source",{src:i.audio_url,type:"audio/wav"},null,8,pe),m(" 您的浏览器不支持音频播放。 ")])])):g("",!0)]),l(A,{class:"user-avatar",color:"deep-purple-lighten-3",size:"36"},{default:n(()=>[l(v,{icon:"mdi-account"})]),_:1})])):(r(),c("div",ve,[l(A,{class:"bot-avatar",color:"deep-purple",size:"36"},{default:n(()=>[fe]),_:1}),a("div",_e,[a("div",{innerHTML:N(V)(i.message),class:"markdown-content"},null,8,ye)])]))]))),128))]))],512),a("div",be,[l(M,{id:"input-field",variant:"outlined",modelValue:e.prompt,"onUpdate:modelValue":s[2]||(s[2]=i=>e.prompt=i),label:e.inputFieldLabel,placeholder:"开始输入...",loading:e.loadingChat,"clear-icon":"mdi-close-circle",clearable:"","onClick:clear":e.clearMessage,class:"message-input",onKeydown:e.handleInputKeyDown,"hide-details":""},{loader:n(()=>[l($,{active:e.loadingChat,height:"3",color:"deep-purple",indeterminate:""},null,8,["active"])]),append:n(()=>[l(S,{text:"发送"},{activator:n(({props:i})=>[l(f,E(i,{onClick:e.sendMessage,class:"send-btn",icon:"mdi-send",variant:"text",color:"deep-purple",disabled:!e.prompt&&e.stagedImagesUrl.length===0&&!e.stagedAudioUrl}),null,16,["onClick","disabled"])]),_:1}),l(S,{text:"语音输入"},{activator:n(({props:i})=>[l(f,E(i,{onClick:s[1]||(s[1]=h=>e.isRecording?e.stopRecording():e.startRecording()),class:"record-btn",icon:e.isRecording?"mdi-stop-circle":"mdi-microphone",variant:"text",color:e.isRecording?"error":"deep-purple"}),null,16,["icon","color"])]),_:1})]),_:1},8,["modelValue","label","loading","onClick:clear","onKeydown"]),e.stagedImagesUrl.length>0||e.stagedAudioUrl?(r(),c("div",Ce,[(r(!0),c(C,null,b(e.stagedImagesUrl,(i,h)=>(r(),c("div",{key:h,class:"image-preview"},[a("img",{src:i,class:"preview-image"},null,8,ke),l(f,{onClick:k=>e.removeImage(h),class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"},null,8,["onClick"])]))),128)),e.stagedAudioUrl?(r(),c("div",we,[l(R,{color:"deep-purple-lighten-4",class:"audio-chip"},{default:n(()=>[l(v,{start:"",icon:"mdi-microphone",size:"small"}),m(" 新录音 ")]),_:1}),l(f,{onClick:e.removeAudio,class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"},null,8,["onClick"])])):g("",!0)])):g("",!0)])])])]}),_:1})]),_:1}))}});export{Ue as default};
